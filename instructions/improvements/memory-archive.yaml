archived:
  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, task-specific vitest config pattern"
    sections_added: []
    memories:
      - task: "vitest-configs-coverage"
        date: "2025-12-15"
        type: "pattern"
        summary: "Port packages with tests need vitest.config.ts with 100% coverage"
        detail: |
          Every port package that has tests (*.test.ts files) should have its own
          vitest.config.ts that enforces 100% coverage thresholds:
          - lines: 100
          - functions: 100
          - branches: 100
          - statements: 100

      - task: "vitest-configs-coverage"
        date: "2025-12-15"
        type: "insight"
        summary: "Find test files first, then check for missing vitest configs"
        detail: |
          When auditing test coverage configs:
          1. Find all test files: find packages -name "*.test.ts"
          2. Find all vitest configs: packages/*/vitest.config.ts
          3. Diff to find packages with tests but no config

      - task: "vitest-configs-coverage"
        date: "2025-12-15"
        type: "command-correction"
        summary: "git reset --hard origin/main to resolve divergent branches"
        detail: |
          When local main diverges from origin/main after a PR merge, use:
          git reset --hard origin/main
          This discards local unpushed commits and aligns with the merged state.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, npm cache workaround"
    sections_added: []
    memories:
      - task: "vitest-4.0.15-upgrade"
        date: "2025-12-15"
        type: "command-correction"
        summary: "Use npm registry curl when npm view fails with permission errors"
        detail: |
          When npm view fails due to cache permission errors, use curl directly:
          curl -s https://registry.npmjs.org/vitest/latest | grep -o '"version":"[^"]*"'

      - task: "vitest-4.0.15-upgrade"
        date: "2025-12-15"
        type: "pattern"
        summary: "Keep @vitest/coverage-v8 version in sync with vitest"
        detail: |
          When updating vitest, ensure @vitest/coverage-v8 is updated to the same
          version. These packages are released together and should match.

      - task: "vitest-4.0.15-upgrade"
        date: "2025-12-15"
        type: "insight"
        summary: "Major vitest upgrades (2-4) work smoothly for basic test setups"
        detail: |
          Vitest major version upgrades from v2/v3 to v4 required no changes to test
          code. The 242 tests across 8 packages all passed without modification.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: task-specific knip and package-lock patterns"
    sections_added: []
    memories:
      - task: "feat/doctor-stage"
        date: "2025-12-15"
        type: "command-correction"
        summary: "Use knip --dependencies to avoid removing exports"
        detail: |
          WRONG: knip --fix - removes all unused exports, breaking the codebase
          RIGHT: knip --fix --dependencies - only handles dependency issues

      - task: "feat/doctor-stage"
        date: "2025-12-15"
        type: "pattern"
        summary: "Keep knip as a devDependency of validation-pipeline, not root"
        detail: |
          knip is a validation concern, not a project-wide tooling concern.
          Placing it in apps/validation-pipeline/package.json keeps responsibilities clear.

      - task: "feat/doctor-stage"
        date: "2025-12-15"
        type: "command-correction"
        summary: "Use main's package-lock.json when npm install breaks types"
        detail: |
          When vitest types break, the issue is often a package-lock.json mismatch. Fix by:
          rm -rf node_modules package-lock.json
          git checkout main -- package-lock.json
          npm install

      - task: "feat/doctor-stage"
        date: "2025-12-15"
        type: "pattern"
        summary: "Add shell-script-only dependencies to knip ignoreDependencies"
        detail: |
          Dependencies used only in shell scripts won't be detected by knip's
          TypeScript analysis. Add them to knip.json ignoreDependencies.

      - task: "feat/doctor-stage"
        date: "2025-12-15"
        type: "insight"
        summary: "Headless reporter should output errors for failed stages"
        detail: |
          The headless reporter was only outputting PASS/FAIL without error details.
          Added error output to reportStageResult to show what actually failed.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: already documented in coding-patterns skill"
    sections_added: []
    memories:
      - task: "feat/control-flow-package"
        date: "2025-12-15"
        type: "misconception"
        summary: "Contract packages must have NO runtime code - not even error classes"
        detail: |
          WRONG: Putting error classes, helper functions, constants in contract packages
          RIGHT: Contracts contain ONLY TypeScript types, interfaces, type aliases
          The rule from coding-patterns: "If it emits JavaScript, it doesn't belong in a contract."

      - task: "feat/control-flow-package"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use 'declare const' for symbols in contracts to define type without value"
        detail: |
          When a contract needs to reference a symbol, use TypeScript's ambient declaration.
          This allows the contract to define the type while the port provides the implementation.

      - task: "feat/control-flow-package"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use timestamps (number) instead of Date objects in contracts"
        detail: |
          For FetchError.rateLimited(), accept the timestamp directly as a number.
          Callers with access to a clock port compute: nowMs + delaySeconds * 1000.
          This keeps the contract hermetic (no global Date usage).

      - task: "feat/control-flow-package"
        date: "2025-12-15"
        type: "insight"
        summary: "tsc-reviewer subagent provides thorough automated review"
        detail: |
          The tsc-reviewer subagent performed a comprehensive review covering architecture,
          security, correctness, maintainability, and type safety.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, package consolidation guidance"
    sections_added: []
    memories:
      - task: "feat/consolidate-error-into-control-flow"
        date: "2025-12-15"
        type: "pattern"
        summary: "When consolidating, check for API signature differences"
        detail: |
          The FetchError constructor changed from positional to options object.
          All call sites must be updated when migrating to a new API.

      - task: "feat/consolidate-error-into-control-flow"
        date: "2025-12-15"
        type: "insight"
        summary: "Abstract base classes still work for instanceof checks"
        detail: |
          ConveauxError changed from a concrete class to an abstract class.
          Abstract classes can serve as instanceof targets for their subclasses.

      - task: "feat/consolidate-error-into-control-flow"
        date: "2025-12-15"
        type: "q-and-a"
        summary: "When to consolidate vs keep separate packages"
        detail: |
          Consolidate when one package is a strict superset of another,
          the separate package adds no unique value, or consolidation simplifies
          the dependency graph.

      - task: "feat/consolidate-error-into-control-flow"
        date: "2025-12-15"
        type: "insight"
        summary: "Exit codes could improve CLI error handling"
        detail: |
          The CLI could leverage ConveauxError.exitCode instead of always using
          process.exit(1). This is a follow-up improvement opportunity.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single task, color configuration patterns"
    sections_added: []
    memories:
      - task: "feat/logger-color-config"
        date: "2025-12-15"
        type: "pattern"
        summary: "FORCE_COLOR must be checked before NO_COLOR in resolution order"
        detail: |
          FORCE_COLOR is meant to OVERRIDE NO_COLOR, so it must be checked first.

      - task: "feat/logger-color-config"
        date: "2025-12-15"
        type: "pattern"
        summary: "Injectable ColorEnvironment for testable NO_COLOR detection"
        detail: |
          Instead of reading process.env directly, inject an environment detector.
          This allows tests to inject mock environments without touching process.env.

      - task: "feat/logger-color-config"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use discriminated unions for color specifications"
        detail: |
          For ColorSpec supporting named colors, 256-color, RGB, or hex,
          use a type discriminant for type-safe handling.

      - task: "feat/logger-color-config"
        date: "2025-12-15"
        type: "insight"
        summary: "plan-writing skill produces thorough API designs"
        detail: |
          Invoking the plan-writing skill before implementation led to clear type
          hierarchy, proper backward compatibility, and comprehensive test coverage.

      - task: "feat/logger-color-config"
        date: "2025-12-15"
        type: "pattern"
        summary: "Export ANSI constants for app-level color consistency"
        detail: |
          Export ANSI constants from port-logger so apps don't duplicate them.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single task, env package patterns"
    sections_added: []
    memories:
      - task: "feat/env-package"
        date: "2025-12-15"
        type: "pattern"
        summary: "Three-state override semantics are reusable for env var sources"
        detail: |
          undefined: Key not present in source, fall through to lower priority
          null: Explicitly unset, shadow lower sources (return empty string)
          string: Override value
          Use Object.hasOwn() to distinguish "key not present" from "key set to undefined".

      - task: "feat/env-package"
        date: "2025-12-15"
        type: "pattern"
        summary: "Priority-based resolution with immutable source composition"
        detail: |
          Sources are registered at factory creation time (immutable composition).
          The factory sorts sources by priority (descending) at creation time.
          First source to return a defined value wins.

      - task: "feat/env-package"
        date: "2025-12-15"
        type: "command-correction"
        summary: "Heredocs in git commit fail in sandbox - use dangerouslyDisableSandbox"
        detail: |
          Git commits using heredoc syntax fail in sandbox because heredocs require
          creating temp files. Use dangerouslyDisableSandbox: true.

      - task: "feat/env-package"
        date: "2025-12-15"
        type: "insight"
        summary: "Explore agents provide comprehensive pattern analysis for planning"
        detail: |
          Launching parallel Explore agents before planning produced complete inventory
          of all contract/port packages and existing patterns.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: already documented in coding-patterns skill (vitest fake timers)"
    sections_added: []
    memories:
      - task: "feat/ephemeral-scheduler"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use vi.useFakeTimers() instead of inline fake timer implementations"
        detail: |
          Vitest's fake timers work perfectly with real globalThis functions.
          Simpler tests, vitest handles edge cases, consistent with other tests.

      - task: "feat/ephemeral-scheduler"
        date: "2025-12-15"
        type: "command-correction"
        summary: "Biome errors go to stderr - combine stdout+stderr for lint output"
        detail: |
          When lint stage fails, combine both stdout and stderr when capturing output.
          Biome outputs error details to stderr while summary goes to stdout.

      - task: "feat/ephemeral-scheduler"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use Record<string, never> for empty object types"
        detail: |
          Biome's noBannedTypes rule flags empty object types.
          Record<string, never> explicitly states "an object with no properties".

      - task: "feat/ephemeral-scheduler"
        date: "2025-12-15"
        type: "insight"
        summary: "Keep AbortController and Scheduler as separate concerns"
        detail: |
          EphemeralScheduler handles time-based scheduling (when to execute).
          AbortController handles cancellation signaling (how to abort).
          Composition of simple abstractions is better than one complex one.

      - task: "feat/ephemeral-scheduler"
        date: "2025-12-15"
        type: "pattern"
        summary: "Extract Biome error patterns for structured lint output"
        detail: |
          Biome outputs errors in format: ./path/to/file.ts:line:col rule_name message
          Extract these with regex for structured reporting.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: task-specific HTML parser patterns"
    sections_added: []
    memories:
      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "command-correction"
        summary: "ID selector regex must allow underscore at start for HTML5 IDs"
        detail: |
          HTML5 IDs like __NEXT_DATA__ start with underscores.
          CSS selectors allow IDs to start with letters, underscores, or hyphens.

      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "pattern"
        summary: "Use charAt() instead of bracket access for string indexing in strict TS"
        detail: |
          charAt() returns empty string for out-of-bounds (not undefined).
          This avoids the need for explicit null checks on every character access.

      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "pattern"
        summary: "Raw content tags need special tokenizer handling"
        detail: |
          Tags like script, style, textarea, and title contain raw text that
          should NOT be tokenized as HTML.

      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "insight"
        summary: "Zero-dependency HTML parsers are feasible for targeted use cases"
        detail: |
          For chatgpt-share, only getElementById and innerHTML were needed.
          A custom parser (~500 lines) replaced Cheerio entirely.

      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "pattern"
        summary: "HTML entity decoding only needs basics for JSON-in-script scenarios"
        detail: |
          HTML5 defines 2,231 named entities, but JSON content only uses basics.
          The implementation can grow to support more entities when needed.

      - task: "feat/zero-dep-html-parser"
        date: "2025-12-15"
        type: "misconception"
        summary: "Cheerio wrappers are not the path to zero dependencies"
        detail: |
          WRONG: Create a CheerioBackend adapter to abstract over Cheerio
          RIGHT: Build custom tokenizer and DOM builder from scratch

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single task, autonomous agent operation patterns"
    sections_added: []
    memories:
      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "pattern"
        summary: "Agent SDK reads ANTHROPIC_API_KEY from process.env - merge .env values early"
        detail: |
          The Claude Agent SDK reads ANTHROPIC_API_KEY directly from process.env.
          To support .env files, load them early and merge into process.env.
          Priority order: shell > .env.local > .env > defaults

      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "command-correction"
        summary: "WallClock interface uses nowMs() not now()"
        detail: |
          The @conveaux/contract-wall-clock interface defines nowMs(), not now().

      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "command-correction"
        summary: "Logger LogContext expects Error objects, not strings"
        detail: |
          The LogContext type expects error to be an Error instance for proper
          serialization. Passing a string causes type errors.

      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "pattern"
        summary: "Gatekeeper pattern: skip Reviewer for LOW impact features"
        detail: |
          Not all features need human/agent review. Use impact levels as a gate.
          LOW impact features can be auto-approved to reduce latency and API costs.

      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "pattern"
        summary: "Consecutive blocks as session termination signal"
        detail: |
          Track consecutive failures separately from total failures.
          3 consecutive blocks likely means systemic issue.

      - task: "feat/ccw-autonomous-operation"
        date: "2025-12-16"
        type: "insight"
        summary: "Stripping complexity is high-value refactoring"
        detail: |
          Removed ~1040 LOC while maintaining all necessary functionality.
          Key question when stripping: "Does this actively enable the core use case?"

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: already documented in app-architecture skill"
    sections_added: []
    memories:
      - task: "pr-approval-checker"
        date: "2025-12-16"
        type: "lesson"
        summary: "Use port-ephemeral-scheduler.delay() for delays instead of raw setTimeout"
        detail: |
          Always use port-ephemeral-scheduler.delay() for delays instead of raw setTimeout.
          The scheduler provides lifecycle management (dispose cancels pending), injectable
          dependencies for testing, and consistent patterns across the codebase.
          Already documented in app-architecture skill's "Common Deps by Use Case" table:
          "Delays/timers | contract-ephemeral-scheduler | port-ephemeral-scheduler"

      - task: "pr-approval-checker"
        date: "2025-12-16"
        type: "pattern"
        summary: "CLI tool file structure for apps/"
        detail: |
          For new CLI tools in apps/, follow this structure:
          - cli.ts: thin entry point, arg parsing with commander
          - composition.ts: composition root, inject all platform globals
          - types.ts: shared type definitions
          - errors.ts: error classes extending ConveauxError
          - [domain].ts: core business logic with injected deps
          Already documented in app-architecture skill's "File Structure" section.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: already documented in devcontainer-sandboxing skill"
    sections_added: []
    memories:
      - task: "coordinator-packages"
        date: "2025-12-16"
        type: "lesson"
        summary: "Sandbox vs direct test execution (tests pass directly, fail in verify.sh sandbox)"
        detail: |
          Tests passed when run directly (npm run test -w @conveaux/port-coordinator)
          but failed through ./verify.sh with EPERM errors about temp file creation.
          The verify script runs in sandbox mode which restricts /tmp writes.
          Solution: Run with dangerouslyDisableSandbox: true per CLAUDE.md which says
          we rely on devcontainer isolation, not Claude Code's sandbox.
          Already documented in devcontainer-sandboxing skill section 7:
          "Disable Claude Code's built-in sandbox when using devcontainers"

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: already documented in coding-loop and effective-git skills"
    sections_added: []
    memories:
      - task: "coordinator-packages"
        date: "2025-12-16"
        type: "pattern"
        summary: "Commit size management (1315 lines split into 3 commits)"
        detail: |
          Initial implementation was 1315 lines across 2 packages. The coding-loop skill
          specifies >500 lines requires splitting. Split into 3 atomic commits:
          1. Contract types (234 lines)
          2. Task router + tests (592 lines)
          3. Execution planner + config (489 lines)
          Already documented in coding-loop skill's "Commit Atomicity Gate" and
          effective-git skill's "The Atomic Commit Standard" section.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, speculative pattern"
    sections_added: []
    memories:
      - task: "coordinator-packages"
        date: "2025-12-16"
        type: "pattern"
        summary: "Breadcrumbs for future decomposition (TODO comments for extraction)"
        detail: |
          When creating packages that combine related concerns, add TODO breadcrumbs:
          /**
           * FUTURE DECOMPOSITION CANDIDATES:
           * - TODO: Extract WorktreeConfig -> contract-worktree
           * - TODO: Extract ProcessConfig -> contract-process-runner
           */
          This signals intent without premature abstraction.
          Rejected: single occurrence, speculative value. If pattern recurs 3+ times,
          reconsider for consolidation.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, devcontainer-verification-stage learnings"
    sections_added: []
    memories:
      - task: "devcontainer-verification-stage"
        date: "2024-12-16"
        type: "pattern"
        summary: "Adding pipeline stages requires updating 4 locations"
        detail: |
          When adding a new stage to the validation pipeline, update:
          1. StageName type in contracts/stage.ts (add to union)
          2. STAGE_DEPENDENCIES in pipeline.ts (define dependencies)
          3. stageRegistry in stages/index.ts (add stage implementation)
          4. DEFAULT_STAGE_ORDER in stages/index.ts (add to array)
          Missing any of these causes runtime errors.
          Rejected: single occurrence, codebase-specific mechanics. This describes
          how this particular pipeline works, not a generalizable pattern.

      - task: "devcontainer-verification-stage"
        date: "2024-12-16"
        type: "command-correction"
        summary: "CLAUDE.md changes must preserve all existing rules"
        detail: |
          WRONG: Simplify CLAUDE.md by removing rules you think are redundant
          RIGHT: Always preserve existing rules, only ADD new ones
          The TSC reviewer caught that removing "No `any` outside test files",
          "Quick Commands", and "Lessons" sections broke project conventions.
          These were unintentional side effects of accepting user-modified content.
          Rejected: single occurrence, obvious corrective note. The lesson "don't
          delete things you didn't mean to delete" is too generic to warrant
          skill documentation.

      - task: "devcontainer-verification-stage"
        date: "2024-12-16"
        type: "pattern"
        summary: "Security trade-offs need explicit documentation"
        detail: |
          When making security trade-offs (like passwordless sudo in containers
          or curl|sh installation patterns), document them explicitly:
          1. What the trade-off is
          2. Why it's acceptable in this context
          3. What the alternative would be for stricter security
          This helps reviewers and future maintainers understand the reasoning.
          Rejected: single occurrence, generic best practice. Standard engineering
          advice that doesn't meet the 3+ occurrence threshold for skill inclusion.

      - task: "devcontainer-verification-stage"
        date: "2024-12-16"
        type: "insight"
        summary: "JSONC parsing requires stripping // comments AND trailing commas"
        detail: |
          devcontainer.json uses JSONC format (JSON with Comments). When parsing:
          1. Strip single-line comments: text.replace(/^\s*\/\/.*$/gm, '')
          2. Strip multi-line comments: text.replace(/\/\*[\s\S]*?\*\//g, '')
          3. Strip trailing commas: text.replace(/,(\s*[}\]])/g, '$1')
          Without all three, JSON.parse() will fail on valid JSONC files.
          Rejected: single occurrence, implementation-specific detail. Useful for
          JSONC parsing but not a generalizable pattern until it recurs.

  - consolidated_date: "2025-12-16"
    consolidated_into: "rejected"
    pattern_name: "Rejected: single occurrence, skill-writing audience learnings"
    sections_added: []
    memories:
      - task: "devcontainer-skill-documentation"
        date: "2025-12-16"
        type: "misconception"
        summary: "Skills teach agents, not human operators"
        detail: |
          WRONG: I wrote SKILL.md explaining how human operators should set up
          infrastructure (VM provisioning, container orchestration, resource sizing).

          RIGHT: Skills teach Claude Code instances how to behave. The audience is
          the agent running inside the environment, not the human setting it up.

          Evidence: User corrected "the audience is a SINGLE claude code instance
          and we are trying to teach it how to use dev containers within this repository"

          Rejected: Single occurrence. While this represents a fundamental
          misconception about skill audience, it does not meet the 3+ occurrence
          threshold. If similar audience-confusion errors recur in future skill-writing
          tasks, reconsider for consolidation into writing-claude-skills skill.

      - task: "devcontainer-skill-documentation"
        date: "2025-12-16"
        type: "pattern"
        summary: "Agent-centric skill writing uses second person"
        detail: |
          Skills should address the agent directly:
          - "You are running inside an isolated devcontainer"
          - "You own specific packages"
          - "You must not modify files outside your owned packages"

          NOT infrastructure documentation like:
          - "Launch 20 containers using devcontainer up"
          - "Size your host VM with 64GB RAM"

          Rejected: Single occurrence. Valuable guidance for skill authoring voice,
          but does not meet 3+ threshold. Watch for recurrence.

      - task: "devcontainer-skill-documentation"
        date: "2025-12-16"
        type: "command-correction"
        summary: "Always invoke coding-loop before PR creation"
        detail: |
          The coding-loop skill requires spawning tsc-reviewer agent before merge.
          I created PR #85 and it was merged before I remembered to invoke coding-loop.

          Correct sequence:
          1. Invoke coding-loop skill at session start
          2. Verify baseline green
          3. Implement changes
          4. Verify again
          5. Create PR
          6. Spawn tsc-reviewer agent
          7. Wait for APPROVED verdict
          8. Then merge

          Rejected: Already documented. The coding-loop skill description says
          "Invoke at session start" and Section 2 "Subagent Review Gate" explicitly
          requires tsc-reviewer approval before merge. This learning represents
          failure to follow existing documentation, not a documentation gap.
